# Docker Deployment - Videoflix Backend

## Quick Start

**‚ö†Ô∏è IMPORTANT: Setup .env file first to avoid auth problems!**

1. **Clone repository and navigate to project**:
```bash
git clone <repository-url>
cd Videoflix
```

2. **Setup environment (REQUIRED)**:
```bash
# Copy template to .env
cp .env.template .env

# Generate and set SECRET_KEY in .env
python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"
# Copy the output and replace SECRET_KEY in .env

# Verify database credentials match docker-compose.yml:
# DB_NAME=videoflix_dev
# DB_USER=postgres
# DB_PASSWORD=postgres
```

3. **Build and start all services**:
```bash
docker-compose up -d
```

4. **Verify deployment**:
- Web API: http://localhost:8001/
- Admin Interface: http://localhost:8001/admin/
- Database: localhost:5433
- Redis: localhost:6380

## Services Overview

### üåê Web Service (Django)
- **Port**: 8001 ‚Üí 8000 (container)
- **Description**: Main Django application with REST API
- **Health Check**: HTTP GET to `/admin/`
- **Auto-creates**: Superuser `admin:admin123`, default categories

### üóÑÔ∏è Database Service (PostgreSQL)
- **Port**: 5433 ‚Üí 5432 (container)
- **Database**: `videoflix_db`
- **User**: `postgres:postgres123`
- **Health Check**: `pg_isready`

### üîÑ Redis Service
- **Port**: 6380 ‚Üí 6379 (container)
- **Description**: Caching and task queue backend
- **Health Check**: Redis PING

### üë∑ Worker Service (Django-RQ)
- **Description**: Background task processing (video conversion)
- **Queue**: Video processing with FFmpeg
- **Logs**: `docker-compose logs worker`

## Available API Endpoints

### Authentication (`/api/`)
- `POST /api/register/` - User registration
- `POST /api/login/` - User login
- `POST /api/logout/` - User logout
- `POST /api/token/refresh/` - JWT token refresh
- `POST /api/password_reset/` - Password reset request
- `POST /api/password_confirm/<uidb64>/<token>/` - Password reset confirm

### Video API (`/api/video/`)
- `GET /api/video/` - List all videos (requires auth)
- `POST /api/video/` - Upload new video (requires auth)
- `GET /api/video/<id>/<resolution>/index.m3u8` - HLS manifest
- `GET /api/video/<id>/<resolution>/<segment>/` - HLS video segments

### Admin Interface
- URL: http://localhost:8001/admin/
- Credentials: `admin` / `admin123`

## Development Commands

### Container Management
```bash
# Start all services
docker-compose up -d

# View logs
docker-compose logs web
docker-compose logs worker
docker-compose logs db
docker-compose logs redis

# Stop all services
docker-compose down

# Rebuild and restart
docker-compose down
docker-compose build
docker-compose up -d

# Enter container shell
docker-compose exec web bash
docker-compose exec db psql -U postgres videoflix_db
```

### Django Commands in Container
```bash
# Run migrations (automatically runs on startup, but can be run manually)
docker-compose exec web python manage.py migrate

# Create migrations after model changes
docker-compose exec web python manage.py makemigrations

# Check migration status
docker-compose exec web python manage.py showmigrations

# Create superuser
docker-compose exec web python manage.py createsuperuser

# Collect static files
docker-compose exec web python manage.py collectstatic

# Django shell
docker-compose exec web python manage.py shell
```

## Environment Variables

The following environment variables are configured in `docker-compose.yml`:

### Web/Worker Services
- `DATABASE_HOST=db`
- `DATABASE_NAME=videoflix_db`
- `DATABASE_USER=postgres`
- `DATABASE_PASSWORD=postgres123`
- `REDIS_HOST=redis`
- `REDIS_PORT=6379`
- `DJANGO_SECRET_KEY=<auto-generated>`

### Database Service
- `POSTGRES_DB=videoflix_db`
- `POSTGRES_USER=postgres`
- `POSTGRES_PASSWORD=postgres123`

## File Structure

```
Videoflix/
‚îú‚îÄ‚îÄ docker-compose.yml          # Multi-service container configuration
‚îú‚îÄ‚îÄ Dockerfile                  # Python/Django container definition
‚îú‚îÄ‚îÄ docker-entrypoint.sh       # Container startup script
‚îú‚îÄ‚îÄ requirements.txt            # Python dependencies
‚îú‚îÄ‚îÄ nginx.conf                 # Nginx configuration (future use)
‚îú‚îÄ‚îÄ core/                      # Django project settings
‚îú‚îÄ‚îÄ auth_app/                  # Authentication API
‚îú‚îÄ‚îÄ video_app/                 # Video management API
‚îú‚îÄ‚îÄ media/                     # Uploaded videos and thumbnails
‚îî‚îÄ‚îÄ staticfiles/              # Collected static files
```

## Troubleshooting

### Port Conflicts
If ports 5433, 6380, or 8001 are already in use:
1. Stop the conflicting services
2. Or modify ports in `docker-compose.yml`

### Database Issues
```bash
# Reset database
docker-compose down
docker volume rm videoflix_postgres_data
docker-compose up -d
```

### Permission Issues
```bash
# Fix media directory permissions
docker-compose exec web chmod -R 755 /app/media
```

### Migration Problems
```bash
# Create fresh migrations
docker-compose exec web python manage.py makemigrations
docker-compose exec web python manage.py migrate
```

## Production Considerations

‚ö†Ô∏è **This setup is for development/testing. For production:**

1. **Security**:
   - Change default passwords
   - Use environment variables for secrets
   - Configure proper CORS settings
   - Use HTTPS/SSL certificates

2. **Performance**:
   - Use production WSGI server (gunicorn)
   - Configure nginx reverse proxy
   - Set up database connection pooling
   - Configure Redis persistence

3. **Monitoring**:
   - Add health checks
   - Configure logging aggregation
   - Set up monitoring alerts

4. **Scaling**:
   - Use managed database service
   - Configure load balancing
   - Set up auto-scaling for workers

## Success Indicators

‚úÖ **Deployment successful when:**
- All 4 containers show "Up" status in `docker-compose ps`
- Web service accessible at http://localhost:8001/admin/
- API returns authentication errors (not 404) for protected endpoints
- Database and Redis show "healthy" status

üéâ **Your Videoflix backend is now running!**